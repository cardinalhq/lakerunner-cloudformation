# Default configuration for core Lakerunner deployment
# This file contains configuration for the main three stacks: common, migration, and services

# API Keys configuration
api_keys:
  - organization_id: 12340000-0000-4000-8000-000000000000
    keys:
      - f70603aa00e6f67999cc66e336134887

# Storage Profiles configuration
storage_profiles:
  - bucket: "${BUCKET_NAME}"  # Will be replaced with actual bucket name
    cloud_provider: aws
    collector_name: lakerunner
    insecure_tls: false
    instance_num: 1
    organization_id: 12340000-0000-4000-8000-000000000000
    region: "${AWS_REGION}"  # Will be replaced with actual region
    use_path_style: true

# Container Images configuration
images:
  migration: "public.ecr.aws/cardinalhq.io/lakerunner:v1.6.3"
  utility: "public.ecr.aws/cardinalhq.io/lakerunner:v1.6.3"
  go_services: "public.ecr.aws/cardinalhq.io/lakerunner:v1.6.3"

# MSK configuration
msk:
  instance_type: "kafka.t3.small"
  broker_nodes: 2
  storage_size_gb: 50
  enable_sasl_scram: true

# Service configurations for core Lakerunner services
services:
  lakerunner-pubsub-sqs:
    signal_type: common
    command: ["/app/bin/lakerunner", "pubsub", "sqs"]
    cpu: 1024
    memory_mib: 2048
    replicas: 1
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-ingest-logs:
    signal_type: logs
    command: ["/app/bin/lakerunner", "ingest-logs"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-ingest-metrics:
    signal_type: metrics
    command: ["/app/bin/lakerunner", "ingest-metrics"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-ingest-traces:
    signal_type: traces
    command: ["/app/bin/lakerunner", "ingest-traces"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-compact-logs:
    signal_type: logs
    command: ["/app/bin/lakerunner", "compact-logs"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-compact-metrics:
    signal_type: metrics
    command: ["/app/bin/lakerunner", "compact-metrics"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-compact-traces:
    signal_type: traces
    command: ["/app/bin/lakerunner", "compact-traces"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-rollup-metrics:
    signal_type: metrics
    command: ["/app/bin/lakerunner", "rollup-metrics"]
    cpu: 1024
    memory_mib: 2048
    replicas: 10
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-sweeper:
    signal_type: common
    command: ["/app/bin/lakerunner", "sweeper"]
    cpu: 256
    memory_mib: 512
    replicas: 1
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  lakerunner-query-api:
    signal_type: common
    command: ["/app/bin/lakerunner", "query-api"]
    cpu: 1024
    memory_mib: 2048
    replicas: 2
    ingress:
      port: 7101
      container_port: 8080
      attach_alb: true
      health_check_path: "/healthz"
      health_check_port: 8090
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"
      EXECUTION_ENVIRONMENT: "ecs"
      QUERY_WORKER_SERVICE_NAME: "lakerunner-query-worker"
      # Note: QUERY_WORKER_CLUSTER_NAME is set dynamically in the template

  lakerunner-query-worker:
    signal_type: common
    command: ["/app/bin/lakerunner", "query-worker"]
    cpu: 4096
    memory_mib: 8192
    replicas: 8
    ingress:
      port: 8081
      description: "From Query API"
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    ephemeral_storage_gib: 30
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"
      LAKERUNNER_QUERY_DISABLE_TABLE_CACHE: "true"
      LAKERUNNER_QUERY_MAX_SEGMENTS_PER_WORKER_PER_WAVE: "50"

  # Boxer service for all compaction and rollup tasks
  lakerunner-boxer-common:
    signal_type: common
    command: ["/app/bin/lakerunner", "boxer", "--all"]
    cpu: 256
    memory_mib: 512
    replicas: 1
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"

  # Monitoring service
  lakerunner-monitoring:
    signal_type: common
    command: ["/app/bin/lakerunner", "monitoring", "serve", "--grpc-port=9090"]
    cpu: 256
    memory_mib: 512
    replicas: 1
    ingress:
      port: 9090
      container_port: 9090
      attach_alb: false
    health_check:
      type: "go"
      command: ["/app/bin/lakerunner", "sysinfo"]
    environment:
      OTEL_METRIC_EXPORT_INTERVAL: "10000"
