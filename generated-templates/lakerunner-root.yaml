{
 "Conditions": {
  "DeployEcs": {
   "Fn::Equals": [
    {
     "Ref": "DeployEcs"
    },
    "Yes"
   ]
  },
  "DeployEcsStack": {
   "Fn::And": [
    {
     "Condition": "DeployEcs"
    },
    {
     "Condition": "DeployVpc"
    }
   ]
  },
  "DeployGrafanaService": {
   "Fn::Equals": [
    {
     "Ref": "DeployGrafanaService"
    },
    "Yes"
   ]
  },
  "DeployMigration": {
   "Fn::Equals": [
    {
     "Ref": "DeployMigration"
    },
    "Yes"
   ]
  },
  "DeployOtelCollector": {
   "Fn::Equals": [
    {
     "Ref": "DeployOtelCollector"
    },
    "Yes"
   ]
  },
  "DeployRds": {
   "Fn::Equals": [
    {
     "Ref": "DeployRds"
    },
    "Yes"
   ]
  },
  "DeployRdsStack": {
   "Fn::And": [
    {
     "Condition": "DeployRds"
    },
    {
     "Condition": "DeployVpc"
    },
    {
     "Condition": "DeployEcs"
    }
   ]
  },
  "DeployServices": {
   "Fn::Equals": [
    {
     "Ref": "DeployServices"
    },
    "Yes"
   ]
  },
  "DeployServicesStack": {
   "Fn::And": [
    {
     "Condition": "DeployServices"
    },
    {
     "Condition": "DeployVpc"
    },
    {
     "Condition": "DeployEcs"
    },
    {
     "Condition": "DeployRds"
    },
    {
     "Condition": "DeployStorage"
    }
   ]
  },
  "DeployStorage": {
   "Fn::Equals": [
    {
     "Ref": "DeployStorage"
    },
    "Yes"
   ]
  },
  "DeployVpc": {
   "Fn::Equals": [
    {
     "Ref": "DeployVpc"
    },
    "Yes"
   ]
  }
 },
 "Description": "Root stack that links all Lakerunner nested stacks. Set Deploy* parameters to control which components are launched.",
 "Parameters": {
  "DeployEcs": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "Yes",
   "Description": "Deploy the ECS infrastructure stack",
   "Type": "String"
  },
  "DeployGrafanaService": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "No",
   "Description": "Deploy the Grafana Service stack",
   "Type": "String"
  },
  "DeployMigration": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "No",
   "Description": "Deploy the Migration stack",
   "Type": "String"
  },
  "DeployOtelCollector": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "No",
   "Description": "Deploy the demo OTEL Collector stack",
   "Type": "String"
  },
  "DeployRds": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "Yes",
   "Description": "Deploy the RDS database stack",
   "Type": "String"
  },
  "DeployServices": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "Yes",
   "Description": "Deploy the Services stack",
   "Type": "String"
  },
  "DeployStorage": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "Yes",
   "Description": "Deploy the Storage (S3/SQS) stack",
   "Type": "String"
  },
  "DeployVpc": {
   "AllowedValues": [
    "Yes",
    "No"
   ],
   "Default": "Yes",
   "Description": "Deploy the VPC stack",
   "Type": "String"
  },
  "TemplateBaseUrl": {
   "Description": "Base URL where nested templates are stored",
   "Type": "String"
  }
 },
 "Resources": {
  "EcsStack": {
   "Condition": "DeployEcsStack",
   "Properties": {
    "Parameters": {
     "VpcId": {
      "Fn::GetAtt": [
       "VpcStack",
       "Outputs.VpcId"
      ]
     }
    },
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-ecs.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "GrafanaServiceStack": {
   "Condition": "DeployGrafanaService",
   "Properties": {
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-grafana-service.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "MigrationStack": {
   "Condition": "DeployMigration",
   "Properties": {
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-migration.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "OtelCollectorStack": {
   "Condition": "DeployOtelCollector",
   "Properties": {
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-demo-otel-collector.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "RdsStack": {
   "Condition": "DeployRdsStack",
   "Properties": {
    "Parameters": {
     "PrivateSubnets": {
      "Fn::GetAtt": [
       "VpcStack",
       "Outputs.PrivateSubnets"
      ]
     },
     "TaskSecurityGroupId": {
      "Fn::GetAtt": [
       "EcsStack",
       "Outputs.TaskSGId"
      ]
     }
    },
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-rds.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "ServicesStack": {
   "Condition": "DeployServicesStack",
   "Properties": {
    "Parameters": {
     "BucketArn": {
      "Fn::GetAtt": [
       "StorageStack",
       "Outputs.BucketArn"
      ]
     },
     "ClusterArn": {
      "Fn::GetAtt": [
       "EcsStack",
       "Outputs.ClusterArn"
      ]
     },
     "DbHost": {
      "Fn::GetAtt": [
       "RdsStack",
       "Outputs.DbEndpoint"
      ]
     },
     "DbPort": {
      "Fn::GetAtt": [
       "RdsStack",
       "Outputs.DbPort"
      ]
     },
     "DbSecretArn": {
      "Fn::GetAtt": [
       "RdsStack",
       "Outputs.DbSecretArn"
      ]
     },
     "PrivateSubnets": {
      "Fn::GetAtt": [
       "VpcStack",
       "Outputs.PrivateSubnets"
      ]
     },
     "PublicSubnets": {
      "Fn::GetAtt": [
       "VpcStack",
       "Outputs.PublicSubnets"
      ]
     },
     "TaskSecurityGroupId": {
      "Fn::GetAtt": [
       "EcsStack",
       "Outputs.TaskSGId"
      ]
     },
     "VpcId": {
      "Fn::GetAtt": [
       "VpcStack",
       "Outputs.VpcId"
      ]
     }
    },
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-services.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "StorageStack": {
   "Condition": "DeployStorage",
   "Properties": {
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-storage.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  },
  "VpcStack": {
   "Condition": "DeployVpc",
   "Properties": {
    "TemplateURL": {
     "Fn::Sub": "${TemplateBaseUrl}/lakerunner-vpc.yaml"
    }
   },
   "Type": "AWS::CloudFormation::Stack"
  }
 }
}
