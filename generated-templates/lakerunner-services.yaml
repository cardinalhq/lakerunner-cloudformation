Conditions:
  AutoScaleLogsServices: !And
    - !Condition 'AutoScalingEnabled'
    - !Condition 'CreateLogsServices'
  AutoScaleMetricsServices: !And
    - !Condition 'AutoScalingEnabled'
    - !Condition 'CreateMetricsServices'
  AutoScaleTracesServices: !And
    - !Condition 'AutoScalingEnabled'
    - !Condition 'CreateTracesServices'
  AutoScalingEnabled: !Equals
    - !Ref 'EnableAutoScaling'
    - 'Yes'
  CreateLogsServices: !Equals
    - !Ref 'EnableLogs'
    - 'Yes'
  CreateMetricsServices: !Equals
    - !Ref 'EnableMetrics'
    - 'Yes'
  CreateTracesServices: !Equals
    - !Ref 'EnableTraces'
    - 'Yes'
  EnableOtlp: !Not
    - !Equals
      - !Ref 'OtelEndpoint'
      - ''
  IsInternetFacing: !Equals
    - !Ref 'AlbScheme'
    - internet-facing
Description: 'Lakerunner Services: ECS services, task definitions, IAM roles, and ALB integration'
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Infrastructure
        Parameters:
          - CommonInfraStackName
          - AlbScheme
      - Label:
          default: Signal Types
        Parameters:
          - EnableLogs
          - EnableMetrics
          - EnableTraces
      - Label:
          default: Query Services Configuration
        Parameters:
          - QueryApiReplicas
          - QueryApiCpu
          - QueryApiMemory
          - QueryWorkerReplicas
          - QueryWorkerCpu
          - QueryWorkerMemory
      - Label:
          default: Worker Services Configuration
        Parameters:
          - IngestLogsReplicas
          - IngestLogsMemory
          - IngestMetricsReplicas
          - IngestMetricsMemory
          - IngestTracesReplicas
          - IngestTracesMemory
          - CompactLogsReplicas
          - CompactLogsMemory
          - CompactMetricsReplicas
          - CompactMetricsMemory
          - CompactTracesReplicas
          - CompactTracesMemory
          - RollupMetricsReplicas
          - RollupMetricsMemory
      - Label:
          default: Other Services Configuration
        Parameters:
          - PubsubSqsReplicas
          - BoxerCommonReplicas
      - Label:
          default: Auto-Scaling Configuration
        Parameters:
          - EnableAutoScaling
          - AutoScalingMaxReplicas
          - AutoScalingCPUTarget
          - AutoScalingScaleOutCooldown
          - AutoScalingScaleInCooldown
      - Label:
          default: MSK Configuration
        Parameters:
          - MSKBrokers
      - Label:
          default: Container Images
        Parameters:
          - GoServicesImage
      - Label:
          default: Telemetry
        Parameters:
          - OtelEndpoint
    ParameterLabels:
      AlbScheme:
        default: ALB Scheme
      AutoScalingCPUTarget:
        default: CPU Target % (Auto-Scaling)
      AutoScalingMaxReplicas:
        default: Max Replicas (Auto-Scaling)
      AutoScalingScaleInCooldown:
        default: Scale-In Cooldown (seconds)
      AutoScalingScaleOutCooldown:
        default: Scale-Out Cooldown (seconds)
      BoxerCommonReplicas:
        default: Boxer Common Replicas
      CommonInfraStackName:
        default: Common Infra Stack Name
      CompactLogsMemory:
        default: Compact Logs Memory (MiB)
      CompactLogsReplicas:
        default: Compact Logs Replicas
      CompactMetricsMemory:
        default: Compact Metrics Memory (MiB)
      CompactMetricsReplicas:
        default: Compact Metrics Replicas
      CompactTracesMemory:
        default: Compact Traces Memory (MiB)
      CompactTracesReplicas:
        default: Compact Traces Replicas
      EnableAutoScaling:
        default: Enable Auto-Scaling
      EnableLogs:
        default: Enable Logs
      EnableMetrics:
        default: Enable Metrics
      EnableTraces:
        default: Enable Traces
      GoServicesImage:
        default: Go Services Image
      IngestLogsMemory:
        default: Ingest Logs Memory (MiB)
      IngestLogsReplicas:
        default: Ingest Logs Replicas
      IngestMetricsMemory:
        default: Ingest Metrics Memory (MiB)
      IngestMetricsReplicas:
        default: Ingest Metrics Replicas
      IngestTracesMemory:
        default: Ingest Traces Memory (MiB)
      IngestTracesReplicas:
        default: Ingest Traces Replicas
      MSKBrokers:
        default: MSK Broker Endpoints
      OtelEndpoint:
        default: OTEL Collector Endpoint
      PubsubSqsReplicas:
        default: Pubsub Sqs Replicas
      QueryApiCpu:
        default: Query Api CPU
      QueryApiMemory:
        default: Query Api Memory (MiB)
      QueryApiReplicas:
        default: Query Api Replicas
      QueryWorkerCpu:
        default: Query Worker CPU
      QueryWorkerMemory:
        default: Query Worker Memory (MiB)
      QueryWorkerReplicas:
        default: Query Worker Replicas
      RollupMetricsMemory:
        default: Rollup Metrics Memory (MiB)
      RollupMetricsReplicas:
        default: Rollup Metrics Replicas
Outputs:
  AlbArn:
    Export:
      Name: !Sub '${AWS::StackName}-AlbArn'
    Value: !Ref 'Alb'
  AlbDNS:
    Export:
      Name: !Sub '${AWS::StackName}-AlbDNS'
    Value: !GetAtt 'Alb.DNSName'
  ExecutionRoleArn:
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionRoleArn'
    Value: !GetAtt 'ExecRole.Arn'
  ServiceLakerunnerBoxerCommonArn:
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-boxer-common-ServiceArn'
    Value: !Ref 'ServiceLakerunnerBoxerCommon'
  ServiceLakerunnerCompactLogsArn:
    Condition: CreateLogsServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-compact-logs-ServiceArn'
    Value: !Ref 'ServiceLakerunnerCompactLogs'
  ServiceLakerunnerCompactMetricsArn:
    Condition: CreateMetricsServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-compact-metrics-ServiceArn'
    Value: !Ref 'ServiceLakerunnerCompactMetrics'
  ServiceLakerunnerCompactTracesArn:
    Condition: CreateTracesServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-compact-traces-ServiceArn'
    Value: !Ref 'ServiceLakerunnerCompactTraces'
  ServiceLakerunnerIngestLogsArn:
    Condition: CreateLogsServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-ingest-logs-ServiceArn'
    Value: !Ref 'ServiceLakerunnerIngestLogs'
  ServiceLakerunnerIngestMetricsArn:
    Condition: CreateMetricsServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-ingest-metrics-ServiceArn'
    Value: !Ref 'ServiceLakerunnerIngestMetrics'
  ServiceLakerunnerIngestTracesArn:
    Condition: CreateTracesServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-ingest-traces-ServiceArn'
    Value: !Ref 'ServiceLakerunnerIngestTraces'
  ServiceLakerunnerMonitoringArn:
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-monitoring-ServiceArn'
    Value: !Ref 'ServiceLakerunnerMonitoring'
  ServiceLakerunnerPubsubSqsArn:
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-pubsub-sqs-ServiceArn'
    Value: !Ref 'ServiceLakerunnerPubsubSqs'
  ServiceLakerunnerQueryApiArn:
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-query-api-ServiceArn'
    Value: !Ref 'ServiceLakerunnerQueryApi'
  ServiceLakerunnerQueryWorkerArn:
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-query-worker-ServiceArn'
    Value: !Ref 'ServiceLakerunnerQueryWorker'
  ServiceLakerunnerRollupMetricsArn:
    Condition: CreateMetricsServices
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-rollup-metrics-ServiceArn'
    Value: !Ref 'ServiceLakerunnerRollupMetrics'
  ServiceLakerunnerSweeperArn:
    Export:
      Name: !Sub '${AWS::StackName}-lakerunner-sweeper-ServiceArn'
    Value: !Ref 'ServiceLakerunnerSweeper'
  TaskRoleArn:
    Export:
      Name: !Sub '${AWS::StackName}-TaskRoleArn'
    Value: !GetAtt 'TaskRole.Arn'
  Tg7101Arn:
    Export:
      Name: !Sub '${AWS::StackName}-Tg7101Arn'
    Value: !Ref 'Tg7101'
Parameters:
  AlbScheme:
    AllowedValues:
      - internet-facing
      - internal
    Default: internal
    Description: 'Load balancer scheme: ''internet-facing'' for external access or ''internal'' for internal access only.'
    Type: String
  AutoScalingCPUTarget:
    Default: '70'
    Description: Target CPU utilization percentage for scaling (e.g., 70 means scale when avg CPU > 70%)
    MaxValue: 95
    MinValue: 10
    Type: Number
  AutoScalingMaxReplicas:
    Default: '10'
    Description: Maximum number of tasks when auto-scaling (applies to all scaled services)
    MaxValue: 50
    MinValue: 1
    Type: Number
  AutoScalingScaleInCooldown:
    Default: '300'
    Description: Seconds to wait after a scale-in before another scale-in can occur
    MaxValue: 3600
    MinValue: 0
    Type: Number
  AutoScalingScaleOutCooldown:
    Default: '60'
    Description: Seconds to wait after a scale-out before another scale-out can occur
    MaxValue: 3600
    MinValue: 0
    Type: Number
  BoxerCommonReplicas:
    Default: '1'
    Description: Number of lakerunner-boxer-common task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  CommonInfraStackName:
    Description: 'REQUIRED: Name of the CommonInfra stack to import infrastructure values from.'
    Type: String
  CompactLogsMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '4096'
    Description: 'Memory (MiB) for lakerunner-compact-logs. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  CompactLogsReplicas:
    Default: '1'
    Description: Number of lakerunner-compact-logs task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  CompactMetricsMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '2048'
    Description: 'Memory (MiB) for lakerunner-compact-metrics. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  CompactMetricsReplicas:
    Default: '1'
    Description: Number of lakerunner-compact-metrics task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  CompactTracesMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '2048'
    Description: 'Memory (MiB) for lakerunner-compact-traces. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  CompactTracesReplicas:
    Default: '1'
    Description: Number of lakerunner-compact-traces task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  EnableAutoScaling:
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: Enable CPU-based auto-scaling for ingest, compact, and rollup services
    Type: String
  EnableLogs:
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: Enable log processing services (ingest-logs, compact-logs)
    Type: String
  EnableMetrics:
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
    Description: Enable metrics processing services (ingest-metrics, compact-metrics, rollup-metrics)
    Type: String
  EnableTraces:
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'No'
    Description: Enable trace processing services (ingest-traces, compact-traces)
    Type: String
  GoServicesImage:
    Default: public.ecr.aws/cardinalhq.io/lakerunner:v1.5.1
    Description: Container image for all Go services (pubsub, ingest, compact, query-api, query-worker, etc.)
    Type: String
  IngestLogsMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '4096'
    Description: 'Memory (MiB) for lakerunner-ingest-logs. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  IngestLogsReplicas:
    Default: '1'
    Description: Number of lakerunner-ingest-logs task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  IngestMetricsMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '2048'
    Description: 'Memory (MiB) for lakerunner-ingest-metrics. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  IngestMetricsReplicas:
    Default: '1'
    Description: Number of lakerunner-ingest-metrics task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  IngestTracesMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '2048'
    Description: 'Memory (MiB) for lakerunner-ingest-traces. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  IngestTracesReplicas:
    Default: '1'
    Description: Number of lakerunner-ingest-traces task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  MSKBrokers:
    Default: ''
    Description: 'REQUIRED: Comma-separated list of MSK broker endpoints (hostname:port)'
    Type: String
  OtelEndpoint:
    Default: ''
    Description: 'OPTIONAL: OTEL collector HTTP endpoint URL (e.g., http://collector-dns:4318). Leave blank to disable OTLP telemetry export.'
    Type: String
  PubsubSqsReplicas:
    Default: '1'
    Description: Number of lakerunner-pubsub-sqs task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  QueryApiCpu:
    AllowedValues:
      - '256'
      - '512'
      - '1024'
      - '2048'
      - '4096'
      - '8192'
      - '16384'
    Default: '1024'
    Description: CPU units for lakerunner-query-api (256, 512, 1024, 2048, 4096, 8192, 16384)
    Type: Number
  QueryApiMemory:
    AllowedValues:
      - '512'
      - '1024'
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
      - '9216'
      - '10240'
      - '11264'
      - '12288'
      - '13312'
      - '14336'
      - '15360'
      - '16384'
      - '17408'
      - '18432'
      - '19456'
      - '20480'
      - '21504'
      - '22528'
      - '23552'
      - '24576'
      - '25600'
      - '26624'
      - '27648'
      - '28672'
      - '29696'
      - '30720'
      - '32768'
      - '36864'
      - '40960'
      - '45056'
      - '49152'
      - '53248'
      - '57344'
      - '61440'
      - '65536'
      - '73728'
      - '81920'
      - '90112'
      - '98304'
      - '106496'
      - '114688'
      - '122880'
    Default: '2048'
    Description: Memory (MiB) for lakerunner-query-api. Must be valid for the selected CPU.
    Type: Number
  QueryApiReplicas:
    Default: '2'
    Description: Number of lakerunner-query-api task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  QueryWorkerCpu:
    AllowedValues:
      - '256'
      - '512'
      - '1024'
      - '2048'
      - '4096'
      - '8192'
      - '16384'
    Default: '2048'
    Description: CPU units for lakerunner-query-worker (256, 512, 1024, 2048, 4096, 8192, 16384)
    Type: Number
  QueryWorkerMemory:
    AllowedValues:
      - '512'
      - '1024'
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
      - '9216'
      - '10240'
      - '11264'
      - '12288'
      - '13312'
      - '14336'
      - '15360'
      - '16384'
      - '17408'
      - '18432'
      - '19456'
      - '20480'
      - '21504'
      - '22528'
      - '23552'
      - '24576'
      - '25600'
      - '26624'
      - '27648'
      - '28672'
      - '29696'
      - '30720'
      - '32768'
      - '36864'
      - '40960'
      - '45056'
      - '49152'
      - '53248'
      - '57344'
      - '61440'
      - '65536'
      - '73728'
      - '81920'
      - '90112'
      - '98304'
      - '106496'
      - '114688'
      - '122880'
    Default: '8192'
    Description: Memory (MiB) for lakerunner-query-worker. Must be valid for the selected CPU.
    Type: Number
  QueryWorkerReplicas:
    Default: '4'
    Description: Number of lakerunner-query-worker task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
  RollupMetricsMemory:
    AllowedValues:
      - '2048'
      - '3072'
      - '4096'
      - '5120'
      - '6144'
      - '7168'
      - '8192'
    Default: '2048'
    Description: 'Memory (MiB) for lakerunner-rollup-metrics. Valid values for 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192'
    Type: Number
  RollupMetricsReplicas:
    Default: '1'
    Description: Number of lakerunner-rollup-metrics task replicas
    MaxValue: 20
    MinValue: 0
    Type: Number
Resources:
  Alb:
    Properties:
      Scheme: !Ref 'AlbScheme'
      SecurityGroups:
        - !Ref 'AlbSecurityGroup'
      Subnets: !If
        - IsInternetFacing
        - !Split
          - ','
          - !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-PublicSubnets
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
        - !Split
          - ','
          - !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-PrivateSubnets
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      Type: application
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
  Alb7101Open:
    Properties:
      CidrIp: '0.0.0.0/0'
      Description: HTTP 7101
      FromPort: 7101
      GroupId: !Ref 'AlbSecurityGroup'
      IpProtocol: tcp
      ToPort: 7101
    Type: AWS::EC2::SecurityGroupIngress
  AlbSecurityGroup:
    Properties:
      GroupDescription: Security group for ALB
      SecurityGroupEgress:
        - CidrIp: '0.0.0.0/0'
          Description: Allow all outbound
          IpProtocol: '-1'
      VpcId: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-VpcId
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
    Type: AWS::EC2::SecurityGroup
  ExecRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Effect: Allow
                Resource:
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}-*'
              - Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Effect: Allow
                Resource: '*'
              - Action:
                  - secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-DbSecretArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-MSKCredentialsArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Effect: Allow
                Resource: !ImportValue
                  Fn::Sub:
                    - ${CommonInfraStackName}-MSKSecretsKeyArn
                    - CommonInfraStackName: !Ref 'CommonInfraStackName'
            Version: '2012-10-17'
          PolicyName: SSMParameterAccess
      RoleName: !Sub '${AWS::StackName}-exec-role'
    Type: AWS::IAM::Role
  Listener7101:
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref 'Tg7101'
          Type: forward
      LoadBalancerArn: !Ref 'Alb'
      Port: '7101'
      Protocol: HTTP
    Type: AWS::ElasticLoadBalancingV2::Listener
  LogGroupLakerunnerBoxerCommon:
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-boxer-common'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerCompactLogs:
    Condition: CreateLogsServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-compact-logs'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerCompactMetrics:
    Condition: CreateMetricsServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-compact-metrics'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerCompactTraces:
    Condition: CreateTracesServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-compact-traces'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerIngestLogs:
    Condition: CreateLogsServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-ingest-logs'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerIngestMetrics:
    Condition: CreateMetricsServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-ingest-metrics'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerIngestTraces:
    Condition: CreateTracesServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-ingest-traces'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerMonitoring:
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-monitoring'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerPubsubSqs:
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-pubsub-sqs'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerQueryApi:
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-query-api'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerQueryWorker:
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-query-worker'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerRollupMetrics:
    Condition: CreateMetricsServices
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-rollup-metrics'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  LogGroupLakerunnerSweeper:
    Properties:
      LogGroupName: !Sub '/ecs/lakerunner-sweeper'
      RetentionInDays: 14
    Type: AWS::Logs::LogGroup
  QueryApiTaskRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Effect: Allow
                Resource:
                  - !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-BucketArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${BucketArn}/*
                    - BucketArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-BucketArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
              - Action:
                  - secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-DbSecretArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-MSKCredentialsArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Effect: Allow
                Resource: !ImportValue
                  Fn::Sub:
                    - ${CommonInfraStackName}-MSKSecretsKeyArn
                    - CommonInfraStackName: !Ref 'CommonInfraStackName'
              - Action:
                  - ecs:ListServices
                  - ecs:DescribeServices
                  - ecs:ListTasks
                  - ecs:DescribeTasks
                Effect: Allow
                Resource: '*'
              - Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                  - elasticfilesystem:DescribeFileSystems
                  - elasticfilesystem:DescribeMountTargets
                  - elasticfilesystem:DescribeAccessPoints
                Effect: Allow
                Resource: '*'
              - Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Effect: Allow
                Resource: '*'
              - Action:
                  - logs:DescribeLogGroups
                  - logs:CreateLogStream
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                Effect: Allow
                Resource: '*'
            Version: '2012-10-17'
          PolicyName: QueryApiAccess
      RoleName: !Sub '${AWS::StackName}-query-api-task-role'
    Type: AWS::IAM::Role
  QueryWorkerTaskRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Effect: Allow
                Resource:
                  - !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-BucketArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${BucketArn}/*
                    - BucketArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-BucketArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
              - Action:
                  - secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-DbSecretArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-MSKCredentialsArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Effect: Allow
                Resource: !ImportValue
                  Fn::Sub:
                    - ${CommonInfraStackName}-MSKSecretsKeyArn
                    - CommonInfraStackName: !Ref 'CommonInfraStackName'
              - Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                  - elasticfilesystem:DescribeFileSystems
                  - elasticfilesystem:DescribeMountTargets
                  - elasticfilesystem:DescribeAccessPoints
                Effect: Allow
                Resource: '*'
              - Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Effect: Allow
                Resource: '*'
              - Action:
                  - logs:DescribeLogGroups
                  - logs:CreateLogStream
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                Effect: Allow
                Resource: '*'
            Version: '2012-10-17'
          PolicyName: QueryWorkerAccess
      RoleName: !Sub '${AWS::StackName}-query-worker-task-role'
    Type: AWS::IAM::Role
  ScalableTargetLakerunnerCompactLogs:
    Condition: AutoScaleLogsServices
    DependsOn:
      - ServiceLakerunnerCompactLogs
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'CompactLogsReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-compact-logs
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalableTargetLakerunnerCompactMetrics:
    Condition: AutoScaleMetricsServices
    DependsOn:
      - ServiceLakerunnerCompactMetrics
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'CompactMetricsReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-compact-metrics
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalableTargetLakerunnerCompactTraces:
    Condition: AutoScaleTracesServices
    DependsOn:
      - ServiceLakerunnerCompactTraces
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'CompactTracesReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-compact-traces
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalableTargetLakerunnerIngestLogs:
    Condition: AutoScaleLogsServices
    DependsOn:
      - ServiceLakerunnerIngestLogs
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'IngestLogsReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-ingest-logs
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalableTargetLakerunnerIngestMetrics:
    Condition: AutoScaleMetricsServices
    DependsOn:
      - ServiceLakerunnerIngestMetrics
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'IngestMetricsReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-ingest-metrics
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalableTargetLakerunnerIngestTraces:
    Condition: AutoScaleTracesServices
    DependsOn:
      - ServiceLakerunnerIngestTraces
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'IngestTracesReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-ingest-traces
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalableTargetLakerunnerRollupMetrics:
    Condition: AutoScaleMetricsServices
    DependsOn:
      - ServiceLakerunnerRollupMetrics
    Properties:
      MaxCapacity: !Ref 'AutoScalingMaxReplicas'
      MinCapacity: !Ref 'RollupMetricsReplicas'
      ResourceId: !Sub
        - service/${ClusterName}/lakerunner-rollup-metrics
        - ClusterName: !ImportValue
            Fn::Sub:
              - ${CommonInfraStackName}-ClusterName
              - CommonInfraStackName: !Ref 'CommonInfraStackName'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
    Type: AWS::ApplicationAutoScaling::ScalableTarget
  ScalingPolicyLakerunnerCompactLogs:
    Condition: AutoScaleLogsServices
    Properties:
      PolicyName: lakerunner-compact-logs-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerCompactLogs'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ScalingPolicyLakerunnerCompactMetrics:
    Condition: AutoScaleMetricsServices
    Properties:
      PolicyName: lakerunner-compact-metrics-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerCompactMetrics'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ScalingPolicyLakerunnerCompactTraces:
    Condition: AutoScaleTracesServices
    Properties:
      PolicyName: lakerunner-compact-traces-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerCompactTraces'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ScalingPolicyLakerunnerIngestLogs:
    Condition: AutoScaleLogsServices
    Properties:
      PolicyName: lakerunner-ingest-logs-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerIngestLogs'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ScalingPolicyLakerunnerIngestMetrics:
    Condition: AutoScaleMetricsServices
    Properties:
      PolicyName: lakerunner-ingest-metrics-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerIngestMetrics'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ScalingPolicyLakerunnerIngestTraces:
    Condition: AutoScaleTracesServices
    Properties:
      PolicyName: lakerunner-ingest-traces-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerIngestTraces'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ScalingPolicyLakerunnerRollupMetrics:
    Condition: AutoScaleMetricsServices
    Properties:
      PolicyName: lakerunner-rollup-metrics-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref 'ScalableTargetLakerunnerRollupMetrics'
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: !Ref 'AutoScalingScaleInCooldown'
        ScaleOutCooldown: !Ref 'AutoScalingScaleOutCooldown'
        TargetValue: !Ref 'AutoScalingCPUTarget'
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
  ServiceLakerunnerBoxerCommon:
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'BoxerCommonReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-boxer-common
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-boxer-common'
      TaskDefinition: !Ref 'TaskDefLakerunnerBoxerCommon'
    Type: AWS::ECS::Service
  ServiceLakerunnerCompactLogs:
    Condition: CreateLogsServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'CompactLogsReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-compact-logs
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-compact-logs'
      TaskDefinition: !Ref 'TaskDefLakerunnerCompactLogs'
    Type: AWS::ECS::Service
  ServiceLakerunnerCompactMetrics:
    Condition: CreateMetricsServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'CompactMetricsReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-compact-metrics
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-compact-metrics'
      TaskDefinition: !Ref 'TaskDefLakerunnerCompactMetrics'
    Type: AWS::ECS::Service
  ServiceLakerunnerCompactTraces:
    Condition: CreateTracesServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'CompactTracesReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-compact-traces
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-compact-traces'
      TaskDefinition: !Ref 'TaskDefLakerunnerCompactTraces'
    Type: AWS::ECS::Service
  ServiceLakerunnerIngestLogs:
    Condition: CreateLogsServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'IngestLogsReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-ingest-logs
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-ingest-logs'
      TaskDefinition: !Ref 'TaskDefLakerunnerIngestLogs'
    Type: AWS::ECS::Service
  ServiceLakerunnerIngestMetrics:
    Condition: CreateMetricsServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'IngestMetricsReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-ingest-metrics
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-ingest-metrics'
      TaskDefinition: !Ref 'TaskDefLakerunnerIngestMetrics'
    Type: AWS::ECS::Service
  ServiceLakerunnerIngestTraces:
    Condition: CreateTracesServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'IngestTracesReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-ingest-traces
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-ingest-traces'
      TaskDefinition: !Ref 'TaskDefLakerunnerIngestTraces'
    Type: AWS::ECS::Service
  ServiceLakerunnerMonitoring:
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: '1'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-monitoring
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-monitoring'
      TaskDefinition: !Ref 'TaskDefLakerunnerMonitoring'
    Type: AWS::ECS::Service
  ServiceLakerunnerPubsubSqs:
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'PubsubSqsReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-pubsub-sqs
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-pubsub-sqs'
      TaskDefinition: !Ref 'TaskDefLakerunnerPubsubSqs'
    Type: AWS::ECS::Service
  ServiceLakerunnerQueryApi:
    DependsOn:
      - Listener7101
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'QueryApiReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: AppContainer
          ContainerPort: 8080
          TargetGroupArn: !Ref 'Tg7101'
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-query-api
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-query-api'
      TaskDefinition: !Ref 'TaskDefLakerunnerQueryApi'
    Type: AWS::ECS::Service
  ServiceLakerunnerQueryWorker:
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'QueryWorkerReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-query-worker
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-query-worker'
      TaskDefinition: !Ref 'TaskDefLakerunnerQueryWorker'
    Type: AWS::ECS::Service
  ServiceLakerunnerRollupMetrics:
    Condition: CreateMetricsServices
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: !Ref 'RollupMetricsReplicas'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-rollup-metrics
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-rollup-metrics'
      TaskDefinition: !Ref 'TaskDefLakerunnerRollupMetrics'
    Type: AWS::ECS::Service
  ServiceLakerunnerSweeper:
    Properties:
      Cluster: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-ClusterArn
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      DesiredCount: '1'
      EnableECSManagedTags: true
      EnableExecuteCommand: true
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-TaskSGId
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
          Subnets: !Split
            - ','
            - !ImportValue
              Fn::Sub:
                - ${CommonInfraStackName}-PrivateSubnets
                - CommonInfraStackName: !Ref 'CommonInfraStackName'
      PropagateTags: SERVICE
      ServiceName: lakerunner-sweeper
      Tags:
        - Key: Component
          Value: Service
        - Key: Environment
          Value: !Ref 'AWS::StackName'
        - Key: ManagedBy
          Value: Lakerunner
        - Key: Name
          Value: !Sub '${AWS::StackName}-lakerunner-sweeper'
      TaskDefinition: !Ref 'TaskDefLakerunnerSweeper'
    Type: AWS::ECS::Service
  TaskDefLakerunnerBoxerCommon:
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - boxer
            - --all
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-boxer-common
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerBoxerCommon'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-boxer-common
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '256'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-boxer-common-task
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerCompactLogs:
    Condition: CreateLogsServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - compact-logs
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-compact-logs
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerCompactLogs'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-compact-logs
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-compact-logs-task
      Memory: !Ref 'CompactLogsMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerCompactMetrics:
    Condition: CreateMetricsServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - compact-metrics
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-compact-metrics
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerCompactMetrics'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-compact-metrics
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-compact-metrics-task
      Memory: !Ref 'CompactMetricsMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerCompactTraces:
    Condition: CreateTracesServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - compact-traces
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-compact-traces
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerCompactTraces'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-compact-traces
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-compact-traces-task
      Memory: !Ref 'CompactTracesMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerIngestLogs:
    Condition: CreateLogsServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - ingest-logs
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-ingest-logs
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerIngestLogs'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-ingest-logs
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-ingest-logs-task
      Memory: !Ref 'IngestLogsMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerIngestMetrics:
    Condition: CreateMetricsServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - ingest-metrics
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-ingest-metrics
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerIngestMetrics'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-ingest-metrics
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-ingest-metrics-task
      Memory: !Ref 'IngestMetricsMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerIngestTraces:
    Condition: CreateTracesServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - ingest-traces
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-ingest-traces
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerIngestTraces'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-ingest-traces
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-ingest-traces-task
      Memory: !Ref 'IngestTracesMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerMonitoring:
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - monitoring
            - serve
            - --grpc-port=9090
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-monitoring
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerMonitoring'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-monitoring
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings:
            - ContainerPort: 9090
              Protocol: tcp
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '256'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-monitoring-task
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerPubsubSqs:
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - pubsub
            - sqs
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-pubsub-sqs
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerPubsubSqs'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-pubsub-sqs
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-pubsub-sqs-task
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerQueryApi:
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - query-api
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-query-api
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
            - Name: EXECUTION_ENVIRONMENT
              Value: ecs
            - Name: QUERY_WORKER_SERVICE_NAME
              Value: lakerunner-query-worker
            - Name: QUERY_WORKER_CLUSTER_NAME
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-ClusterName
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerQueryApi'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-query-api
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: !Ref 'QueryApiCpu'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-query-api-task
      Memory: !Ref 'QueryApiMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'QueryApiTaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerQueryWorker:
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - query-worker
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-query-worker
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerQueryWorker'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-query-worker
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings:
            - ContainerPort: 8081
              Protocol: tcp
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: !Ref 'QueryWorkerCpu'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-query-worker-task
      Memory: !Ref 'QueryWorkerMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'QueryWorkerTaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerRollupMetrics:
    Condition: CreateMetricsServices
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - rollup-metrics
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-rollup-metrics
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerRollupMetrics'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-rollup-metrics
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '1024'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-rollup-metrics-task
      Memory: !Ref 'RollupMetricsMemory'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskDefLakerunnerSweeper:
    Properties:
      ContainerDefinitions:
        - Command:
            - /app/bin/lakerunner
            - sweeper
          Environment:
            - Name: OTEL_SERVICE_NAME
              Value: lakerunner-sweeper
            - Name: TMPDIR
              Value: /scratch
            - Name: HOME
              Value: /scratch
            - Name: STORAGE_PROFILE_FILE
              Value: env:STORAGE_PROFILES_ENV
            - Name: API_KEYS_FILE
              Value: env:API_KEYS_ENV
            - Name: SQS_QUEUE_URL
              Value: !Sub 'https://sqs.${AWS::Region}.amazonaws.com/${AWS::AccountId}/lakerunner-ingest-queue'
            - Name: SQS_REGION
              Value: !Ref 'AWS::Region'
            - Name: LRDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LRDB_DBNAME
              Value: lakerunner
            - Name: LRDB_USER
              Value: lakerunner
            - Name: LRDB_SSLMODE
              Value: require
            - Name: CONFIGDB_HOST
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbEndpoint
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PORT
              Value: !ImportValue
                Fn::Sub:
                  - ${CommonInfraStackName}-DbPort
                  - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_DBNAME
              Value: lakerunner
            - Name: CONFIGDB_USER
              Value: lakerunner
            - Name: CONFIGDB_SSLMODE
              Value: require
            - Name: LAKERUNNER_KAFKA_BROKERS
              Value: !Ref 'MSKBrokers'
            - Name: LAKERUNNER_KAFKA_TLS_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_ENABLED
              Value: 'true'
            - Name: LAKERUNNER_KAFKA_SASL_MECHANISM
              Value: SCRAM-SHA-512
            - Name: OTEL_EXPORTER_OTLP_ENDPOINT
              Value: !If
                - EnableOtlp
                - !Ref 'OtelEndpoint'
                - !Ref 'AWS::NoValue'
            - Name: ENABLE_OTLP_TELEMETRY
              Value: !If
                - EnableOtlp
                - 'true'
                - !Ref 'AWS::NoValue'
          HealthCheck:
            Command:
              - /app/bin/lakerunner
              - sysinfo
            Interval: 30
            Retries: 3
            StartPeriod: 60
            Timeout: 5
          Image: !Ref 'GoServicesImage'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref 'LogGroupLakerunnerSweeper'
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: lakerunner-sweeper
          MountPoints:
            - ContainerPath: /scratch
              ReadOnly: false
              SourceVolume: scratch
          Name: AppContainer
          PortMappings: []
          Secrets:
            - Name: STORAGE_PROFILES_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/storage_profiles'
            - Name: API_KEYS_ENV
              ValueFrom: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/lakerunner/api_keys'
            - Name: LRDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: CONFIGDB_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-DbSecretArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_USERNAME
              ValueFrom: !Sub
                - '${SecretArn}:username::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
            - Name: LAKERUNNER_KAFKA_SASL_PASSWORD
              ValueFrom: !Sub
                - '${SecretArn}:password::'
                - SecretArn: !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-MSKCredentialsArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
          User: '0'
      Cpu: '256'
      ExecutionRoleArn: !GetAtt 'ExecRole.Arn'
      Family: lakerunner-sweeper-task
      Memory: '512'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
        - Name: scratch
    Type: AWS::ECS::TaskDefinition
  TaskFromAlb8080:
    Properties:
      Description: ALB to query-api app port
      FromPort: 8080
      GroupId: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-TaskSGId
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      IpProtocol: tcp
      SourceSecurityGroupId: !Ref 'AlbSecurityGroup'
      ToPort: 8080
    Type: AWS::EC2::SecurityGroupIngress
  TaskFromAlb8090:
    Properties:
      Description: ALB health checks
      FromPort: 8090
      GroupId: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-TaskSGId
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
      IpProtocol: tcp
      SourceSecurityGroupId: !Ref 'AlbSecurityGroup'
      ToPort: 8090
    Type: AWS::EC2::SecurityGroupIngress
  TaskRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Effect: Allow
                Resource:
                  - !ImportValue
                    Fn::Sub:
                      - ${CommonInfraStackName}-BucketArn
                      - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${BucketArn}/*
                    - BucketArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-BucketArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
              - Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Effect: Allow
                Resource:
                  - !Sub 'arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:lakerunner-*'
              - Action:
                  - secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-DbSecretArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub
                    - ${SecretArn}*
                    - SecretArn: !ImportValue
                        Fn::Sub:
                          - ${CommonInfraStackName}-MSKCredentialsArn
                          - CommonInfraStackName: !Ref 'CommonInfraStackName'
                  - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-*'
              - Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Effect: Allow
                Resource: !ImportValue
                  Fn::Sub:
                    - ${CommonInfraStackName}-MSKSecretsKeyArn
                    - CommonInfraStackName: !Ref 'CommonInfraStackName'
              - Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                  - elasticfilesystem:DescribeFileSystems
                  - elasticfilesystem:DescribeMountTargets
                  - elasticfilesystem:DescribeAccessPoints
                Effect: Allow
                Resource: '*'
              - Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Effect: Allow
                Resource: '*'
              - Action:
                  - logs:DescribeLogGroups
                  - logs:CreateLogStream
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                Effect: Allow
                Resource: '*'
            Version: '2012-10-17'
          PolicyName: S3AndSQSAccess
      RoleName: !Sub '${AWS::StackName}-task-role'
    Type: AWS::IAM::Role
  Tg7101:
    Properties:
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /healthz
      HealthCheckPort: '8090'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: '200'
      Port: 8080
      Protocol: HTTP
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'false'
        - Key: deregistration_delay.timeout_seconds
          Value: '5'
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !ImportValue
        Fn::Sub:
          - ${CommonInfraStackName}-VpcId
          - CommonInfraStackName: !Ref 'CommonInfraStackName'
    Type: AWS::ElasticLoadBalancingV2::TargetGroup

